<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motion • Ethereum & Base</title>
  <meta name="description" content="Motion — EVM swaps for Ethereum & Base with a 0.05% convenience fee." />
  <meta name="theme-color" content="#089000">
  <style>
    :root{--bg:#0b0b0f;--card:#12121a;--muted:#8a8aa0;--text:#f5f6fa;--accent:#089000}
    html,body{background:var(--bg);color:var(--text);margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;margin:8px 0 20px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px;color:var(--accent);text-decoration:none}
    .logo-badge{width:36px;height:36px;border-radius:12px;background:var(--accent);display:grid;place-items:center;color:#0b0b0f;font-weight:900}
    .nav{display:flex;gap:10px}
    .btn{background:var(--card);border:1px solid #1f2030;color:var(--text);padding:10px 14px;border-radius:12px;text-decoration:none}
    .btn:hover{border-color:var(--accent);color:var(--accent)}
    .card{background:var(--card);border:1px solid #1f2030;border-radius:16px;padding:20px}
    h1,h2{color:var(--accent);margin:6px 0}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .stack{display:grid;gap:12px}
    .row{display:flex;gap:8px;align-items:center}
    select,input{background:#0f0f18;border:1px solid #2a2b3a;color:var(--text);border-radius:10px;padding:10px;font-size:14px;width:100%}
    label{font-size:12px;color:var(--muted)}
    .cta{display:inline-block;background:var(--accent);color:#0b0b0f;padding:10px 14px;border-radius:12px;text-decoration:none;font-weight:700;border:none;cursor:pointer}
    .cta:hover{filter:brightness(1.05)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;background:#171724;border:1px solid #24243a;border-radius:8px;padding:2px 6px}
    .note{font-size:13px;color:var(--muted)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .highlight{color:var(--accent);font-weight:600}
    .status a{color:var(--accent)}
    #toast{position:fixed;bottom:20px;right:20px;background:#1d1f2a;color:#fff;padding:12px 16px;border-radius:8px;opacity:0;transition:opacity .3s}
    #toast.show{opacity:1}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;background:#0f0f18;border:1px solid #2a2b3a}
    .dot{width:10px;height:10px;border-radius:50%}
    .logo-ic{width:16px;height:16px;display:inline-block;line-height:0}
    .logo-ic img{width:16px;height:16px;display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a href="index.html" class="logo"><div class="logo-badge">M</div><div>Motion</div></a>
      <nav class="nav">
        <a class="btn" href="index.html">Solana</a>
        <a class="btn" href="evm.html">Ethereum & Base</a>
      </nav>
    </header>

    <div class="grid">
      <section class="card">
        <h1>EVM Swap (0x Aggregator)</h1>
        <p class="muted">Swap on <strong>Ethereum</strong> or <strong>Base</strong>. Motion takes a tiny <strong>0.05%</strong> convenience fee to <span class="mono">0x39619CF172D558949158D68851ceaa6a3CBBC38f</span>. Funds stay in your wallet.</p>

        <div class="stack" id="app">
          <div class="row">
            <div style="flex:1">
              <label>Network</label>
              <select id="chain">
                <option value="1">Ethereum</option>
                <option value="8453">Base</option>
              </select>
            </div>
            <div style="flex:2">
              <label>Wallet</label>
              <div class="row">
                <input id="account" placeholder="Not connected" readonly>
                <button id="connect" class="cta" style="white-space:nowrap">Connect</button>
              </div>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>From token</label>
              <select id="sellToken">
                <option value="ETH" data-chain="1">ETH (Mainnet)</option>
                <option value="0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2" data-chain="1">WETH (Mainnet)</option>
                <option value="0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48" data-chain="1">USDC (Mainnet)</option>
                <option value="ETH" data-chain="8453">ETH (Base)</option>
                <option value="0x4200000000000000000000000000000000000006" data-chain="8453">WETH (Base)</option>
                <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913" data-chain="8453">USDC (Base)</option>
                <option value="0xd9aAEc86B65D86f6A7B5B1b0c42FFA531710b6CA" data-chain="8453">USDbC (Base)</option>
                <option value="0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22" data-chain="8453">cbETH (Base)</option>
              </select>
              <div class="row" style="margin-top:6px">
                <span class="badge"><span id="sellDot" class="dot"></span><span id="sellLogo" class="logo-ic"></span><span id="sellSym">—</span></span>
              </div>
            </div>
            <div style="flex:1">
              <label>To token</label>
              <select id="buyToken">
                <option value="0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48" data-chain="1">USDC (Mainnet)</option>
                <option value="0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2" data-chain="1">WETH (Mainnet)</option>
                <option value="ETH" data-chain="1">ETH (Mainnet)</option>
                <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913" data-chain="8453">USDC (Base)</option>
                <option value="0xd9aAEc86B65D86f6A7B5B1b0c42FFA531710b6CA" data-chain="8453">USDbC (Base)</option>
                <option value="0x4200000000000000000000000000000000000006" data-chain="8453">WETH (Base)</option>
                <option value="0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22" data-chain="8453">cbETH (Base)</option>
                <option value="ETH" data-chain="8453">ETH (Base)</option>
              </select>
              <div class="row" style="margin-top:6px">
                <span class="badge"><span id="buyDot" class="dot"></span><span id="buyLogo" class="logo-ic"></span><span id="buySym">—</span></span>
              </div>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Amount (sell)</label>
              <input id="amount" type="number" min="0" step="any" placeholder="0.0">
            </div>
            <div style="flex:1">
              <label>Quote (price)</label>
              <input id="quote" placeholder="--" readonly>
            </div>
          </div>

          <div class="row">
            <button id="getQuote" class="btn" style="flex:1">Get Quote</button>
            <button id="swap" class="cta" style="flex:1">Swap</button>
          </div>

          <div class="note">Slippage: 1%. Fee: <span class="highlight">0.05% Motion fee</span> on output (sent to <span class="mono">0x39619CF172D558949158D68851ceaa6a3CBBC38f</span>).</div>
          <div id="status" class="note status"></div>
        </div>
      </section>

      <aside class="card">
        <h2>Details</h2>
        <p class="muted">Fee recipient (EVM): <span class="mono">0x39619CF172D558949158D68851ceaa6a3CBBC38f</span></p>
        <p class="muted">Supported networks: Ethereum (1), Base (8453).</p>
        <h2>Troubleshooting</h2>
        <ul class="muted">
          <li>If your wallet is on the wrong network, switch it in your wallet first.</li>
          <li>Some tokens require an <em>Approve</em> step before swapping.</li>
          <li>Gas is paid by you in the connected wallet – Motion never holds funds.</li>
        </ul>
      </aside>
    </div>

    <footer class="muted" style="margin-top:24px">© <span id="yr"></span> Motion DEX • Non-custodial UI.</footer>
  </div>

  <div id="toast"></div>

  <script>
    document.getElementById('yr').textContent = new Date().getFullYear();

    const feeRecipient = '0x39619CF172D558949158D68851ceaa6a3CBBC38f';
    const feePct = 0.0005;

    const KNOWN_DECIMALS = {
      1: {
        'eth': 18,
        '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2': 18,
        '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48': 6
      },
      8453: {
        'eth': 18,
        '0x4200000000000000000000000000000000000006': 18,
        '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913': 6,
        '0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca': 6,
        '0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22': 18
      }
    };

    const els = { chain:chain, account:account, connect:connect, sellToken:sellToken, buyToken:buyToken, amount:amount, quote:quote, getQuote:getQuote, swap:swap, status:status };

    const state = { account:null, allowanceTarget:null, quote:null, sellDecimals:18, buyDecimals:18 };

    function $(id){ return document.getElementById(id); }
    function setStatus(html){ $('status').innerHTML = html || ''; }
    function showToast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }

    function ensureWindowEthereum(){ if(!window.ethereum){ alert('Install an EVM wallet (MetaMask/Rabby).'); throw new Error('no provider'); } return window.ethereum; }

    async function connectWallet(){
      const eth = ensureWindowEthereum();
      const accts = await eth.request({ method:'eth_requestAccounts' });
      state.account = accts[0];
      $('account').value = state.account;
      const desired = '0x'+parseInt($('chain').value,10).toString(16);
      const curr = await eth.request({ method:'eth_chainId' });
      if(curr !== desired){ try{ await eth.request({ method:'wallet_switchEthereumChain', params:[{ chainId:desired }] }); }catch(e){} }
    }

    $('connect').addEventListener('click', connectWallet);

    function tokenForChain(selectEl){
      const cid = parseInt($('chain').value,10);
      const opts = Array.from(selectEl.options).filter(o => parseInt(o.dataset.chain||'1',10)===cid);
      if(!opts.find(o=>o.value===selectEl.value)) selectEl.value = opts[0].value;
    }

    $('chain').addEventListener('change', ()=>{ tokenForChain($('sellToken')); tokenForChain($('buyToken')); setStatus(''); $('quote').value='--'; });

    function addrKey(v){ return (v||'').toString().toLowerCase(); }

    async function fetchDecimals(token, chainId){
      if(token==='ETH') return 18;
      const known = KNOWN_DECIMALS[chainId] && KNOWN_DECIMALS[chainId][addrKey(token)];
      if(typeof known==='number') return known;
      try{
        const eth = ensureWindowEthereum();
        const res = await eth.request({ method:'eth_call', params:[{ to: token, data:'0x313ce567' }, 'latest'] });
        return parseInt(res,16)||18;
      }catch{ return 18; }
    }

    function toBaseUnits(amountStr, decimals){
      const [i,fRaw=''] = String(amountStr).split('.');
      const f = fRaw.slice(0,decimals);
      const padded = (f + '0'.repeat(decimals)).slice(0,decimals);
      const base = BigInt(10)**BigInt(decimals);
      return (BigInt(i||'0')*base + BigInt(padded||'0')).toString();
    }
    function fromBaseUnits(amountStr, decimals){
      const n = BigInt(amountStr||'0');
      const base = BigInt(10)**BigInt(decimals);
      const i = n/base; const f=(n%base).toString().padStart(decimals,'0').replace(/0+$/,'');
      return f?`${i}.${f}`:i.toString();
    }

    async function getAQuote(){
      setStatus('Fetching quote…');
      if(!state.account) await connectWallet();
      const chainId = parseInt($('chain').value,10);
      const sellIsEth = $('sellToken').value==='ETH';
      const buyIsEth  = $('buyToken').value==='ETH';
      const sellToken = sellIsEth ? 'ETH' : $('sellToken').value;
      const buyToken  = buyIsEth  ? 'ETH' : $('buyToken').value;
      const amountUi  = $('amount').value;
      if(!amountUi || +amountUi<=0){ setStatus('Enter a valid amount.'); return; }

      state.sellDecimals = await fetchDecimals(sellToken, chainId);
      state.buyDecimals  = await fetchDecimals(buyToken, chainId);
      const sellAmount   = toBaseUnits(amountUi, sellIsEth?18:state.sellDecimals);

      const url = new URL('https://api.0x.org/swap/v1/quote');
      url.searchParams.set('chainId', String(chainId));
      url.searchParams.set('sellToken', sellToken);
      url.searchParams.set('buyToken', buyToken);
      url.searchParams.set('sellAmount', sellAmount);
      url.searchParams.set('takerAddress', state.account);
      url.searchParams.set('slippagePercentage', '0.01');
      url.searchParams.set('feeRecipient', feeRecipient);
      url.searchParams.set('buyTokenPercentageFee', String(feePct));

      const res = await fetch(url.toString());
      if(!res.ok){ setStatus('Quote failed. Try another pair/amount.'); return; }
      const data = await res.json();
      state.quote = data; state.allowanceTarget = data.allowanceTarget||null;
      $('quote').value = data.price || '--';
      const finalBuy = data.buyAmount ? fromBaseUnits(data.buyAmount, state.buyDecimals) : '?';
      setStatus(`Final buy amount (after 0.05% fee): <span class="highlight">${finalBuy}</span>`);
    }

    async function approveIfNeeded(){
      if($('sellToken').value==='ETH') return;
      if(!state.quote || !state.allowanceTarget) return;
      const eth = ensureWindowEthereum();
      const token = $('sellToken').value;
      const selector='0x095ea7b3';
      const spender=state.allowanceTarget.toLowerCase().replace('0x','').padStart(64,'0');
      const amt='f'.repeat(64);
      const tx = { from: state.account, to: token, data: selector+spender+amt };
      await eth.request({ method:'eth_sendTransaction', params:[tx] });
    }

    function explorerBase(chainId){ return chainId===8453?'https://basescan.org/tx/':'https://etherscan.io/tx/'; }

    async function doSwap(){
      if(!state.quote){ setStatus('Get a quote first.'); return; }
      const chainId = parseInt($('chain').value,10);
      const chainHex='0x'+chainId.toString(16);
      const eth = ensureWindowEthereum();
      const curr = await eth.request({ method:'eth_chainId' });
      if(curr!==chainHex){ try{ await eth.request({ method:'wallet_switchEthereumChain', params:[{ chainId:chainHex }] }); }catch(e){ alert('Switch network first.'); return; }}
      try { await approveIfNeeded(); } catch(e){ setStatus('Approval failed or rejected.'); return; }

      const tx = { from: state.quote.from, to: state.quote.to, data: state.quote.data, value: state.quote.value||'0x0', gas: state.quote.gas||undefined, gasPrice: state.quote.gasPrice||undefined };
      setStatus('Submitting swap…');
      try{
        const hash = await eth.request({ method:'eth_sendTransaction', params:[tx] });
        const link = explorerBase(chainId)+hash;
        setStatus(`Swap sent: <a href="${link}" target="_blank" rel="noopener">${hash.slice(0,10)}…</a> <a href="#" id="copyHash">(copy)</a>`);
        document.getElementById('copyHash').onclick=(e)=>{e.preventDefault();navigator.clipboard.writeText(hash);showToast('TX hash copied');};
        showToast('Swap submitted');
      }catch(e){ console.error(e); setStatus('Swap rejected or failed.'); }
    }

    $('getQuote').addEventListener('click', getAQuote);
    $('swap').addEventListener('click', doSwap);

    tokenForChain($('sellToken')); tokenForChain($('buyToken'));
  </script>
</body>
</html>
